<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.spring.mvc.user.service.impl.UserMapper">

	<resultMap id="userInfo" type="co.spring.mvc.user.service.UserVO">
		<result property="memberId" column="member_id"/>
		<result property="userId" column="user_id"/>
		<result property="password" column="password"/>
		<result property="name" column="name"/>
		<result property="email" column="email"/>
		<result property="failCnt" column="fail_cnt"/>
		<result property="isDeleted" column="is_deleted"/>
		<result property="lockUser" column="lock_user"/>
		
	</resultMap>
	
	<!-- <resultMap id="depart" type="co.spring.mvc.user.service.DepartVO">
		<result property="departmentId" column="department_id"/>
		<result property="departmentName" column="department_name"/>
	</resultMap>
 -->

	<select id="getDepartmentList" resultType="egovMap">
		SELECT
			*
		FROM DEPARTMENT
		WHERE 1=1
	</select>
	
	<insert id="singUp" parameterType="userVO">
		INSERT INTO MEMBER (
			user_id
			, password
		  	, name
		  	, email
		  	, department_id
		  	, is_deleted
		  	, created_at
		  	, user_grade
		  	, fail_cnt
		  	, lock_user
		)
		VALUES (
			#{userId}
			, #{password}
			, #{name}
			, #{email}
			, #{departmentId}
			, 'N'
			, NOW()
			, 'user'
			, 0
			,'N'
		)
	</insert>
	
	<select id="IdCnt" parameterType="userVO" resultType="int">
		SELECT
			COUNT(user_id)
		FROM MEMBER
		WHERE 1=1
			AND user_id = #{userId}
			AND is_deleted ='N'
	</select>
	
	<select id="findByUser" parameterType="String" resultMap="userInfo">
		SELECT
			member_id
			, user_id
			, password
			, name
			, email
			, fail_cnt
			, is_deleted
			, lock_user
		FROM MEMBER
		WHERE 1=1
			AND user_id = #{value}
			AND is_deleted ='N'
	</select>
	
	<update id="incrementFailureCount" parameterType="String">
		UPDATE MEMBER SET
			fail_cnt = fail_cnt + 1
		WHERE 1=1
			AND user_id = #{value}
			AND is_deleted ='N'
	</update>
	
	<select id="getFailureCount" parameterType="String" resultType="int">
		SELECT
			fail_cnt
		FROM MEMBER
		WHERE 1=1
			AND	user_id = #{value}
			AND is_deleted ='N'
	</select>
	
	<update id ="lockUserAccount" parameterType="String">
		UPDATE MEMBER SET
			lock_user = 'Y'
		WHERE 1=1
			AND user_id = #{value}
			AND is_deleted ='N'
	</update>
	
	<select id ="checkUserExists" parameterType="String" resultType="Boolean">
		SELECT
			COUNT(1)
		FROM MEMBER
		WHERE 1=1
			AND user_id = #{value}
			AND is_deleted ='N'
	</select>
	
	<update id ="resetFailCountAndUnlockUser" parameterType="String">
		UPDATE MEMBER SET
			fail_cnt = 0
			, lock_user = 'N'
		WHERE 1=1
			AND user_id = #{value}
			AND is_deleted ='N'
	
	</update>


</mapper>